---
import Layout from '~/layouts/PageLayout.astro';
import Hero from '~/components/widgets/Hero.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import Features from '~/components/widgets/Features.astro';
import TextBlock from '~/components/blocks/TextBlock.astro';
import StatsBlock from '~/components/blocks/StatsBlock.astro';
import FeatureGrid from '~/components/blocks/FeatureGrid.astro';

// Read TinaCMS content
import { readFileSync } from 'fs';
import { join } from 'path';

let pageData;
try {
  const contentPath = join(process.cwd(), 'src/content/pages/home.md');
  const rawContent = readFileSync(contentPath, 'utf-8');
  
  // Parse frontmatter
  const frontmatterMatch = rawContent.match(/^---\n([\s\S]*?)\n---/);
  if (frontmatterMatch) {
    // Simple YAML parsing for our structure
    const yamlContent = frontmatterMatch[1];
    
    // Extract basic fields
    const title = yamlContent.match(/title:\s*"([^"]+)"/)?.[1] || 'Aries Group';
    const description = yamlContent.match(/description:\s*"([^"]+)"/)?.[1] || '';
    
    // For demo, use simplified data structure
    pageData = {
      title,
      description,
      hero: {
        title: "European Leader in Sheet Metal Processing",
        subtitle: "Aries Group provides comprehensive sheet metal processing solutions with cutting-edge technology and decades of expertise across multiple production sites in Europe.",
        buttons: [
          { text: "Get Quote", href: "/contact", style: "primary" },
          { text: "Virtual Tour", href: "/production-sites", style: "secondary" }
        ]
      },
      blocks: [
        {
          _template: "statsBlock",
          title: "Our Track Record",
          subtitle: "Proven expertise across Europe",
          stats: [
            { number: "25+", label: "Years of Experience", description: "Industry expertise since 1999" },
            { number: "12", label: "Production Sites", description: "Across European markets" },
            { number: "250+", label: "Employees", description: "Skilled manufacturing professionals" },
            { number: "15+", label: "Countries Served", description: "European and international clients" }
          ]
        },
        {
          _template: "textBlock",
          title: "Welcome to Aries Group",
          background: "white",
          content: `
            <p>Leading European manufacturer specializing in precision sheet metal processing with advanced technology and comprehensive solutions.</p>
            
            <h3>Our Expertise</h3>
            <ul>
              <li>Advanced sheet metal processing</li>
              <li>Precision manufacturing</li>
              <li>European production capabilities</li>
              <li>Technology-driven solutions</li>
            </ul>
          `
        },
        {
          _template: "featureGrid",
          title: "Our Capabilities",
          subtitle: "Comprehensive sheet metal processing solutions with cutting-edge technology",
          columns: "3",
          features: [
            {
              title: "Precision Laser Cutting",
              description: "Advanced fiber laser technology for high-precision cutting of various materials and thicknesses.",
              icon: "tabler:cut"
            },
            {
              title: "CNC Punching & Forming",
              description: "Automated punching and forming processes for complex geometries and high-volume production.",
              icon: "tabler:settings"
            },
            {
              title: "Welding & Assembly",
              description: "Professional welding services and complete assembly solutions with certified quality standards.",
              icon: "tabler:flame"
            },
            {
              title: "Quality Control",
              description: "ISO 9001:2015 certified quality management with advanced inspection and testing capabilities.",
              icon: "tabler:shield-check"
            },
            {
              title: "European Production",
              description: "Strategic production sites across Europe ensuring rapid delivery and local support.",
              icon: "tabler:world"
            },
            {
              title: "Custom Solutions",
              description: "Tailored manufacturing processes designed to meet specific customer requirements and specifications.",
              icon: "tabler:puzzle"
            }
          ]
        }
      ]
    };
  }
} catch (error) {
  // Fallback if file doesn't exist
  pageData = {
    title: 'Aries Group',
    description: 'Sheet Metal Processing Excellence',
    hero: {
      title: "European Leader in Sheet Metal Processing",
      subtitle: "Comprehensive sheet metal processing solutions.",
      buttons: []
    },
    blocks: []
  };
}

const metadata = {
  title: pageData.title,
  description: pageData.description,
};
---

<Layout metadata={metadata}>
  <!-- Hero Section -->
  <Hero
    actions={pageData.hero.buttons.map(btn => ({
      variant: btn.style === 'primary' ? 'primary' : 'secondary',
      text: btn.text,
      href: btn.href,
    }))}
    image={{ src: '~/assets/images/hero-image.png', alt: 'Aries Group Sheet Metal Processing' }}
  >
    <Fragment slot="title">
      {pageData.hero.title}
    </Fragment>

    <Fragment slot="subtitle">
      {pageData.hero.subtitle}
    </Fragment>
  </Hero>

  <!-- Render Blocks -->
  {pageData.blocks.map((block) => {
    if (block._template === 'statsBlock') {
      return (
        <StatsBlock 
          title={block.title}
          subtitle={block.subtitle}
          stats={block.stats}
        />
      );
    }
    
    if (block._template === 'textBlock') {
      return (
        <TextBlock 
          title={block.title}
          content={block.content}
          background={block.background}
        />
      );
    }
    
    if (block._template === 'featureGrid') {
      return (
        <FeatureGrid
          title={block.title}
          subtitle={block.subtitle}
          features={block.features}
          columns={parseInt(block.columns)}
          background="white"
        />
      );
    }
    
    return null;
  })}

  <!-- Call to Action -->
  <CallToAction
    actions={[
      {
        variant: 'primary',
        text: 'Request Quote',
        href: '/contact',
      },
      {
        text: 'View Capabilities',
        href: '/technology',
      },
    ]}
  >
    <Fragment slot="title">
      Ready to Start Your Project?
    </Fragment>

    <Fragment slot="subtitle">
      Get in touch with our expert team to discuss your sheet metal processing requirements. 
      We provide custom quotes and technical consultations.
    </Fragment>
  </CallToAction>
</Layout>